<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Denunciar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    
    <link rel="stylesheet" href="../assets/css/all.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>
    <link rel="stylesheet" href="../assets/css/cit.css">
    <link rel="icon" href="../assets/icons/favicon.ico" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>
</head>

<body>

    <div class="row m-0 p-0" style="background-color: #EBF2F5;">

        <div id="lateral" class="col-12 col-sm-12 col-md-2 col-lg-2 col-xl-2 m-0 p-0">
            <img class="d-block pt-2 m-auto" src="../assets/img/citlogo.svg" width="128px" height="128px" alt="">
        </div>
        
        <div id="main" class="col-12 col-sm-12 col-md-10 col-lg-10 col-xl-10 m-0 p-0">

            <div id="navegacao" class="row">
                <nav class="cit-breadcrumb" aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="../index.html"><i class="fas fa-home"></i> &nbsp; Início</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Denunciar</li>
                    </ol>
                </nav>
            </div>
            
            <div class="row" id="formulario">
                <h2>Denunciar</h2>
                <h4>Localização do problema</h4>
                <div id="mapa">
                    <div class="card" style="width: 100%; border-radius: 16px;overflow: hidden;">
                        <div id="map"></div>
                        <h5 class="card-title" style="padding: 10px 0;">Clique para adicionar a localização</h5>
                    </div>
                </div>
                <label>Endereço</label>
                <input id="endereco" class="d-block" type="text" disabled="">
                <p hidden id="cep"></p>
                <p hidden id="uf"></p>
                <p hidden id="municipio"></p>
                <p hidden id="logradouro"></p>
                <h4>Sobre o problema</h4>
                <label>Categoria</label>
                <div class="categorias">
                    <select class="custom-select my-1 mr-sm-2" id="selectCategoria">
                        <option id="selectCatOp" selected value="0">Escolha...</option>
                    <!--   <option value="1">Hídrica</option>
                        <option value="2">Elétrica</option>
                        <option value="3">Estrutural</option> -->
                      </select>
                </div>
                <label>Descrição</label>
                <textarea class="form-control" id="areaDescricao" rows="3"></textarea>
                <label for="inputFile">Foto</label>
                <input type="file" class="form-control-file" id="inputFile" accept="image/x-png,image/jpeg">

                <label class="d-block" id="anonimaL">Fazer Denúncia de Forma Anônima?</label>
                
                <div id="anonimaB">
                    <div class="btn-group" data-toggle="buttons">
                        <label class="btn btn-success active primeiro">
                          <input value="0" type="radio" name="nomeRadio" id="idRadio" autocomplete="off" checked> Não 
                        </label>
                        <label class="btn btn-success">
                            <input value="1" type="radio" name="nomeRadio" id="idRadio" autocomplete="off"> Sim
                        </label>
                      </div>
                </div>

                <div id="finalizar">
                    <Button class="btn btn-outline-success Confirmar" id="confirmar">Confirmar</Button>
                </div>
            </div>

        </div>

    </div>

    <div id="myModal" class="modal modal-dialog-scrollable" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        Denúncias próximas desta localidade
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
            </div>
            <div class="modal-body">
              <p>Alguma delas pode corresponder ao problema que você deseja denunciar</p>
            </div>
            <footer class="modal-footer">
                <small>Nenhuma delas corresponde ao seu problema?</small>
                <button id="btnContinuar" type="button" class="btn btn-primary">Continuar com Denúncia</button>
            </footer>
          </div>
        </div>
    </div>
    
    <script src="../assets/js/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <script src="/assets/js/cit.js"></script>
</body>

</html>

<script>
    function bs_input_file() {
	$(".input-file").before(
		function() {
			if ( ! $(this).prev().hasClass('input-ghost') ) {
				var element = $("<input type='file' class='input-ghost' style='visibility:hidden; height:0'>");
				element.attr("name",$(this).attr("name"));
				element.change(function(){
					element.next(element).find('input').val((element.val()).split('\\').pop());
				});
				$(this).find("button.btn-choose").click(function(){
					element.click();
				});
				$(this).find("button.btn-reset").click(function(){
					element.val(null);
					$(this).parents(".input-file").find('input').val('');
				});
				$(this).find('input').css("cursor","pointer");
				$(this).find('input').mousedown(function() {
					$(this).parents('.input-file').prev().click();
					return false;
				});
				return element;
			}
		}
	);
}
$(function() {
	bs_input_file();
});

//funções que envolvem o mapa
var marker

const handleClick = event =>{

    //seta marker se ja existir, senao cria
    if (marker)
        marker.setLatLng( event.latlng );
    else
        marker = L.marker(event.latlng, {icon}).addTo(map)

    const {lat,lng} = event.latlng;

    fetch(`http://52.188.152.85:81/denunciasProximas/${lat}/${lng}`, {method:'GET'})//
    .then( res => res.json() )
    .then( jsonRes => {
        if (jsonRes.length > 0){
            
            $('#myModal .modal-body').html('<p>Alguma delas pode corresponder ao problema que você deseja denunciar</p>');
            preencherModal(jsonRes)
            $('#btnContinuar').click( () => {
                $('#myModal').modal('hide')
            })
            $('#myModal').modal('show');
        }
    } )
    .catch( error => console.log(error) )
    
    geocode(lat,lng);

}

const preencherModal = denuncias => {

    denuncias.forEach( denuncia =>{
        let content = `
        <div class="denunciaProxima">
        <div class="denuncia">
            <div id="denuncia${denuncia.id}" class="denunciaCard card-horizontal m-0 p-0" style="display: flex;">
                <div class="dashboard-photos">
                    <img class="p-2" src="${denuncia.url}" alt="Card image cap"/>
                </div>
                <div class="card-body infoDenuncia">
                    <p class="card-title"> ${denuncia.logradouro} </p>
                    <p> ${denuncia.descricao} </p>
                </div>
            </div>
        </div>
        </div>
        ` 

        $('#myModal .modal-body').append( content );
        $('#denuncia' + denuncia.id).click( () =>{
            window.location.href = 'visualizar.html?id='+ denuncia.id
        })

    } )
}

const geocode = (lat,lng) => {
    
    var urlReq = `https://api.opencagedata.com/geocode/v1/json?q=${lat}+${lng}&key=21c6df39ed504b4e886b065d9aa8d6f9`
    fetch(urlReq, {method:'GET'})
    .then( res => res.json() )
    .then( jsonRes => {
        document.getElementById("endereco").value = jsonRes.results[0].formatted;
        document.getElementById("cep").innerHTML = jsonRes.results[0].components.postcode;
        document.getElementById("uf").innerHTML = jsonRes.results[0].components.state_code;
        document.getElementById("logradouro").innerHTML = jsonRes.results[0].components.road;
        if(jsonRes.results[0].components.town == undefined)
            document.getElementById("municipio").innerHTML = jsonRes.results[0].components.city;
        else
            document.getElementById("municipio").innerHTML = jsonRes.results[0].components.town;
    } )
    .catch( error => console.log(error) )

}

var map = L.map('map')
map.on('click', handleClick)

//definindo icone personalizado para marcadores
const icon = L.icon({
    iconUrl: '../../assets/img/citlogo.svg',

    iconSize:     [38, 95], // size of the icon
    iconAnchor:   [20, 62], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -30] // point from which the popup should open relative to the iconAnchor
})

$(function(){

map.setView({lat:-12.5, lng: -50},4)


var url_string = window.location.href;
var url = new URL(url_string);
var lat = url.searchParams.get("lat");
var lng = url.searchParams.get("lng");

if (lat && lng){
    map.setView([lat,lng], 16)
    marker = L.marker([lat,lng],{icon}).addTo(map);

    geocode(lat,lng)
}
else{
//acessar localização
    map.locate();
    map.on('locationfound', res =>{
        map.setView([res.latitude, res.longitude], 16)
    })
    map.on('locationerror', error => console.log(error))
}

//estilização gratuita mas esteticamente menos agradável
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

})

/*var valorCategoria = document.getElementById("selectCategoria").value;
const elementoCategoria = document.getElementById("selectCategoria");
elementoCategoria.addEventListener('change', function(){
    valorCategoria = document.getElementById("selectCategoria").value;
    console.log(valorCategoria);
}, false)

var valorDescricao = document.getElementById("areaDescricao").value;
const elementoDescricao = document.getElementById("areaDescricao");
elementoDescricao.addEventListener('change', function(){
    valorCategoria = document.getElementById("areaDescricao").value;
    console.log(valorCategoria);
}, false)

var valorRadio = console.log(document.querySelector('input[name="nomeRadio"]:checked').value)
$(document).ready(function(){
    console.log("a")
    $('input[name=nomeRadio]').change(function() {
        valorRadio = this.value;
    });
});*/

var valorFoto = "https://i.imgur.com/uY1aiTr.png";



/*
var urlReq = `https://api.opencagedata.com/geocode/v1/json?q=${lat}+${lng}&key=21c6df39ed504b4e886b065d9aa8d6f9`
fetch(urlReq, {method:'GET'})
    .then( res => res.json() )
    .then( jsonRes => {
        document.getElementById("endereco").value = jsonRes.results[0].formatted;
        document.getElementById("cep").innerHTML = jsonRes.results[0].components.postcode;
        document.getElementById("uf").innerHTML = jsonRes.results[0].components.state_code;
        document.getElementById("logradouro").innerHTML = jsonRes.results[0].components.road;
        if(jsonRes.results[0].components.town == undefined)
            document.getElementById("municipio").innerHTML = jsonRes.results[0].components.city;
        else
            document.getElementById("municipio").innerHTML = jsonRes.results[0].components.town;
    } )
    .catch( error => console.log(error) )
}*/
    var file;
    $('#inputFile').change(function (event) {
        console.log(event.target.files)
        file = event.target.files[0]
    });

    $("#confirmar").click(function() {
        var today = new Date();
        var date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();
        var time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
        var tempoAtual = date+' '+time;
            // Requisição Jquery Ajax, equivalente ao método fetch do js puro
            if($("#selectCategoria").val()==0 || !$("#areaDescricao").val() || !valorFoto || !$("#cep").text() || !$("#logradouro").text() || !$("#uf").text() || !$("#municipio").text()) {
                alert("Categoria, preencha todos os campos e marque um endereço válido!!");
                return;
            }
            console.log($('#fotoInput').prop('files'))
            let form = new FormData();
            form.append('denuncia_cep', $("#cep").text());
            form.append('denuncia_logradouro', $("#logradouro").text());
            form.append('denuncia_referencia', "testeRef");
            form.append('denuncia_uf', $("#uf").text());
            form.append('denuncia_municipio', $("#municipio").text());
            form.append('denuncia_categoria', $("#selectCategoria").val());
            form.append('denuncia_latitude', marker.getLatLng().lat);
            form.append('denuncia_longitude', marker.getLatLng().lng);
            form.append('contribuicao_descricao', $("#areaDescricao").val());
            form.append('contribuicao_anonimo', $('input[name=nomeRadio]:checked' ).val());
            form.append('file', file);
            //form.append('fileUpload', );
            $.ajax({
                url: "/denunciar",//
                enctype: 'multipart/form-data',
                processData: false,
                contentType: false,
                type: "POST",
                data: form,
                success: function(data, status){
                    alert("Denúncia cadastrada!");
                    window.location.href = "./mapadenuncia.html"
                    $("#selectCategoria").val(0); //Equivalente a: document.getElementById("txtNomeCidadao").value = "";
                    $("#areaDescricao").val("");
                    $("#valorRadio").val(0);
                    $("#endereco").val("");
                },
                error: function(data, status){
                    alert("Erro ao cadastrar");
                },
            });
        });

        $(function() {
        $.ajax({
            url: `/denuncia/categorias`,
            type: "GET",
            success: function(data, status){

                for (i = 0; i < data.length; i++)
                { 
                    $('#selectCategoria').append($('<option>',
                    {
                        value: data[i].id,
                        text : data[i].descricao
                    }));
                }

            },
            error: function(data, status){
                console.log("Erro ao buscar denuncias");
            },
        });
    })

</script>

<style>
    
#lateral{
    background-color: #54D0B1;
}

#addLoc{
    color: #66ccff;
}

#main{
    background-color: #EBF2F5;
    display: flex;
    align-items: center;
    justify-content: center;
}
#endereco{
    background-color: lightgray;  
}
#main>#navegacao{
    position: absolute;
    top: 0;
    left: 0;
    margin-left: 2%;
}

#formulario{
    background-color: white;
    width: 50%;
    margin-top: 50px;
    margin-bottom: 50px;
    border: 1px solid #D3E2E5;
    border-radius: 16px;
    display: block;
    /*align-items: center;
    justify-content: center;*/
    color: #4D6F80;
}

#formulario h2, h4{
    margin: 0;
    padding: 5% 0 1% 5%;
    text-decoration: none;
}

#formulario>#mapa{
    display: flex;
    justify-content: center;
    padding-right: 5%;
    text-align: center;
    padding: 5% 5% 1% 5%;
}

#formulario>label{
    margin: 0;
    padding: 2% 0 1% 5%;
}

#formulario input{
    margin-left: 5%;
    width: 89%;
    margin-bottom: 5%;
}

#formulario select{
    margin-left: 5%;
    width: 88%;
    margin-bottom: 5%;
    padding-right: 0;
}

#formulario>textarea{
    margin-left: 5%;
    width: 89%;
    resize: none;
    padding-right: 0;
}

#formulario #foto{
    margin-left: 5%;
    width: 91%;
}

#formulario>#anonimaL{
    padding-top: 0;
    margin-bottom: 2.5%;
}

#formulario>#anonimaB{
    display: flex;
    margin-left: 5%;
    align-items: center;
    justify-content: right;
}

#anonimaB label{
    display: flex;
    padding: 8px 16px;
    border-radius: 8px;
}

#anonimaB .primeiro{
    margin-right: 25%;
}

#finalizar{
    margin-top: 8%;
    display: flex;
    align-items: center;
    justify-content: center;
}

#finalizar>button{
    margin: 0;
    width: 90%;
    margin-bottom: 40px;
}
#map{
    width: 100%;
    height: 200px;
}

/*modal*/
.denunciaProxima+.denunciaProxima{
    margin-top: 20px;
}
.denunciaProxima img{
    width: 100px;
    height: 100px;
    border-radius: 25px;
    padding: 0px;
}
.denunciaProxima .denunciaCard{
    color: white;
    border-radius: 10px;
    background-color: #4DCBAB;
    transition: background-color 0.3s;
}
.denunciaProxima .denunciaCard:hover{
    background-color: #38AE90;
    cursor: pointer;
}
#myModal footer button{
    background-color: #4DCBAB;
    border-color: #4DCBAB;
}
#myModal footer button:hover{
    background-color: #38AE90;
    border-color: #38AE90;
}

</style>