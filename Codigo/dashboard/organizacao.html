<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CIT</title>
  <link rel="stylesheet" href="../assets/css/bootstrap.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="../assets/css/all.min.css" crossorigin="anonymous">
  <script src="../assets/js/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
  <script src="../assets/js/bootstrap.min.js" crossorigin="anonymous"></script>
  <link rel="icon" href="../assets/icons/favicon.ico" />
</head>

<body>

  <div class="background">

    <div class="row m-0 p-0">

      <div class="col-12 col-sm-12 col-md-3 col-lg-3 col-xl-3 m-0 p-0 position-relative">
        <div id="lateral" class="col-12 col-sm-12 col-md-3 col-lg-3 col-xl-3">
          <a id="voltar" class="btn btn-outline-secondary position-absolute m-1" href="../index.html">
            <i class="fas fa-arrow-left"></i>
          </a>
          <img src="../../assets/img/citlogo.svg" width="150px" alt="CIT Logo" class="d-block m-auto">
          <hr>
          <h3>Número de denúncias: <p id="qtdDenuncias" class="d-inline-flex"> ?</p></h3>
          <hr>
          <div class="final">
            <h4 id="createUser"> Criar usuário <i class="fas fa-plus"></i> </h4>
            <hr>
            <h4><i class="fas fa-university text-white d-inline"></i> <p id="orgNome" class="d-inline-flex"> Carregando</p></h3>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-12 col-md-9 col-lg-9 col-xl-9">
        <div id="denuncias">
          <h1>Denúncias designadas a sua Organização</h1>
          <hr>

          <div class="row">
            <div class="input-group mb-3 col-md-8">
              <input id="pesquisaInput" type="text" class="form-control" placeholder="Pesquisar" aria-describedby="basic-addon2">
              <div class="input-group-append"> <button id="btnPesquisa" class="btn btn-outline-success"><i
                    class="fas fa-search"></i></button>
              </div>
            </div>

            <div class="categorias col-md-4 mb-3 ml-10">
              <select class="custom-select my-1 mr-sm-2" id="selectOpcao">
                <option value="1">Mais Antigo</option>
                <option value="2">Mais Recente</option>
                <option value="3">Mais Relevante</option>
              </select>
            </div>
          </div>

          <div class="lista mb-5">

            <div id="listaDenuncias">

              <div id="denuncia">
                <h3>Carregando</h3>
              </div>

            </div>

          </div>

        </div>
      </div>
    </div>

  </div>
  <script src="/assets/js/cit.js"></script>
</body>

<script>

  var url_string = window.location.href;
  var url = new URL(url_string);
  var idOrganizacao = url.searchParams.get("id");
  var qopcao = url.searchParams.get("opcao");

$(function() {
      $.ajax({
          url: `http://52.188.152.85:81/dashorganizacao/nome?id=${idOrganizacao}`,
          type: "GET",
          success: function(data, status){
              $("#orgNome").text(data[0].nome)
          },
          error: function(data, status){
              console.log("Erro ao buscar nome");
          },
      });
  })

  $(function() {
      $.ajax({
          url: `http://52.188.152.85:81/dashorganizacao/qtdDenuncia?id=${idOrganizacao}`,
          type: "GET",
          success: function(data, status){
              $("#qtdDenuncias").text(data[0].qtd_Denuncias)
          },
          error: function(data, status){
              console.log("Erro ao buscar nome");
          },
      });
  })

  var opcaoSelect = 1;
  $('#selectOpcao').on('change', function() {
    if(this.value==1){
      opcaoSelect=1
      carregarDenuncias();
    }
    else if(this.value==2){
      opcaoSelect=2
      carregarDenuncias();
    }
    else if(this.value==3){
      opcaoSelect=3
      carregarDenuncias();
    }
    else{
      opcaoSelect=1
      carregarDenuncias();
    }
  });

  var pesquisaText = "";
  $("#btnPesquisa" ).click(function() {
    pesquisaText = $("#pesquisaInput").val()
    carregarDenuncias()
  });


  function carregarDenuncias(){
    $.ajax({
            url: `http://52.188.152.85:81/dashorganizacao/denuncia?id=${idOrganizacao}&opcao=${opcaoSelect}&texto=${pesquisaText}`,
            type: "GET",
            success: function(data, status){

                $("#denuncia").html("")

                for(let i=0; i<data.length; i++) {

                  let dataConvertida = new Date(data[i].criado_em).toLocaleString()

                  var statusTf=0;
                  if(data[i].status=='S')
                    statusTf = `<a style='color: green;'>Solucionada</a>`
                  else if(data[i].status=='A')
                    statusTf = `<a style='color: blue;'>Em andamento</a>`
                  else 
                    statusTf = `<a style='color: red;'>Não solucionada</a>`

                    if(data[i].url_fotos!=null){
                    var fotos = data[i].url_fotos.split(",")
                    if(fotos[1]==null)
                      fotos[1] = "../assets/img/semimg.png"
                  } else
                    var fotos = "../assets/img/semimg.png,../assets/img/semimg.png".split(",")

                  $("#denuncia").append(`
                      <a href="/denuncia/visualizar.html?id=${data[i].id}" style="text-decoration:none; color: 	#1C1C1C;"> 
                        <div class="card-horizontal m-0 p-0" style="display: flex; background-color: #dadada;">
                        <div class="dashboard-photos">
                          <img class="p-2" src="${fotos[0]}" alt="Card image cap" />
                          <img class="p-2" src="${fotos[1]}" alt="Card image cap" />
                        </div>

                        <div class="card-body">
                          <h4 class="card-title"> ${data[i].logradouro}, ${data[i].municipio} - ${data[i].uf} <small>CEP: ${data[i].cep}</small> </h4>
                          <p class="card-text">Breve explicação: ${data[i].descricao}</p>
                          <p class="card-text">Status: ${statusTf}</p>
                        </div>
                        </div>
                        <div class="card-footer mb-2">
                          <small class="text-muted">Contribuição criada em: ${dataConvertida}</small>
                        </div>
                      </a>
                    `)

                }

            },
            error: function(data, status){
                console.log("Erro ao buscar denuncias");
            },
        });
  }

  $(function() {
    carregarDenuncias();
  })

</script>

<style>
  .background {
    height: 100vh;
    background-color: #ffffff;
  }

  #lateral {
    height: 100vh;
    background: #38ae90;
    position: fixed;
  }

  #lateral hr {
    border: 0.5px solid white;
    margin: 5px 10px;
  }

  #lateral h3 {
    padding: 8px 0;
    font-size: 1.4rem;
    color: white;
    margin: auto;
    text-align: center;
  }

  #lateral h4 {
    color: white;
    font-size: 1.5rem;
    text-align: center;
    padding: 8px;
  }

  #lateral .final {
    position: absolute;
    bottom: 0;
    width: 100%;
  }

  #denuncias h1 {
    margin-top: 10px;
    text-align: center;
  }

  #denuncias hr {
    border: 0.5px solid black;
    width: 100%;
  }

  .dashboard-photos {
    position: relative;
    height: 125px;
    width: 125px;
  }

  .dashboard-photos img {
    height: 80px;
    width: 80px;
    border-radius: 20px;
  }

  .dashboard-photos :first-child {
    position: absolute;
    top: 0;
    left: 0;
  }

  .dashboard-photos :last-child {
    position: absolute;
    bottom: 0;
    right: 0;
  }

  #createUser{
    transition: color 0.3s;
  }
  #createUser:hover{
    color: #c2c2c2;
    cursor: pointer;
  }

  @media only screen and (max-width: 768px) {
    #lateral {
      height: 350px;
      position: relative;
    }

    .denuncia {
      align-items: center;
      text-align: center;
    }

    .card-horizontal {
      align-items: center;
      text-align: center;
    }

    .dashboard-photos :first-child,
    .dashboard-photos :last-child {
      position: relative;
    }

    .dashboard-photos {
      height: auto;
    }
  }

</style>

<script>

$('#createUser').click( () =>{
  location.href = "./criarUsuario.html?org_id=" + 1 // id da organização
} )

</script>

</html>